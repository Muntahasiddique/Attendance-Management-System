<!DOCTYPE html>
<html lang="en">
  <%- include("./includes/head.ejs", { title: "Settings" }) %>
</head>
<body class="bg-background min-h-screen">
  <!-- Sidebar -->
  <%- include("./includes/sidebar.ejs", {active: "settings"}) %>
  
  <!-- Main Content -->
  <main class="ml-64 p-8">
    <div class="mb-8">
      <h1 class="text-2xl font-bold text-foreground">System Configuration</h1>
      <p class="text-muted mt-1">Adjust technical parameters and system settings</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Camera Settings -->
      <div class="bg-card border border-border rounded-xl p-6">
        <div class="flex items-center gap-3 mb-6">
          <div class="w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center">
            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
          </div>
          <div>
            <h3 class="font-semibold text-foreground">Camera Settings</h3>
            <p class="text-sm text-muted">Configure video input sources</p>
          </div>
        </div>

        <div class="space-y-5">
          <div>
            <label class="block text-sm font-medium text-foreground mb-2">Active Camera</label>
            <select id="cameraType" class="w-full px-4 py-3 bg-background border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
              <option value="webcam">Built-in Webcam (Default)</option>
              <option value="usb">USB Camera</option>
              <option value="ip">IP Camera (RTSP)</option>
              <option value="video">Pre-recorded Video</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-foreground mb-2">Resolution</label>
            <select id="resolution" class="w-full px-4 py-3 bg-background border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
              <option value="1080p">1920 x 1080 (Full HD)</option>
              <option value="720p">1280 x 720 (HD)</option>
              <option value="480p">854 x 480 (SD)</option>
            </select>
          </div>

          <div id="ipCameraSection">
            <label class="block text-sm font-medium text-foreground mb-2">IP Camera URL (RTSP)</label>
            <input type="text" id="ipCameraUrl" placeholder="rtsp://192.168.0.103:554/11" class="w-full px-4 py-3 bg-background border border-border rounded-lg text-foreground placeholder-muted focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
            <p class="text-xs text-muted mt-2">Enter the RTSP URL of your IP camera. This will be used instead of built-in camera.</p>
          </div>

          <div id="videoFileSection" style="display: none;">
            <label class="block text-sm font-medium text-foreground mb-2">Upload Video File</label>
            <div class="border-2 border-dashed border-border rounded-lg p-4 text-center hover:border-primary transition-colors">
              <input type="file" id="videoFileInput" accept="video/*" class="hidden">
              <div id="videoUploadArea" onclick="document.getElementById('videoFileInput').click()" class="cursor-pointer">
                <svg class="w-8 h-8 mx-auto text-muted mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                <p class="text-sm text-muted">Click to upload or drag and drop</p>
                <p class="text-xs text-muted mt-1">MP4, AVI, MOV, MKV (max 500MB)</p>
              </div>
              <div id="videoFileInfo" class="hidden">
                <div class="flex items-center justify-between">
                  <span id="videoFileName" class="text-sm text-foreground truncate"></span>
                  <button onclick="clearVideoFile()" class="text-destructive hover:text-destructive/80 ml-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
            <div id="uploadProgress" class="hidden mt-2">
              <div class="w-full bg-background rounded-full h-2">
                <div id="uploadProgressBar" class="bg-primary h-2 rounded-full transition-all" style="width: 0%"></div>
              </div>
              <p id="uploadProgressText" class="text-xs text-muted mt-1">Uploading... 0%</p>
            </div>
            <p class="text-xs text-muted mt-2">Upload a video file to use for attendance detection. The video will be processed frame by frame.</p>
          </div>

          <button onclick="testCamera()" id="testCameraBtn" class="w-full py-3 px-4 bg-background border border-border text-foreground font-medium rounded-lg hover:bg-card transition-all flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
            </svg>
            Test Camera Connection
          </button>
        </div>
      </div>

      <!-- Time Settings -->
      <div class="bg-card border border-border rounded-xl p-6">
        <div class="flex items-center gap-3 mb-6">
          <div class="w-10 h-10 rounded-xl bg-warning/10 flex items-center justify-center">
            <svg class="w-5 h-5 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div>
            <h3 class="font-semibold text-foreground">Time Settings</h3>
            <p class="text-sm text-muted">Configure attendance time rules</p>
          </div>
        </div>

        <div class="space-y-5">
          <div>
            <label class="block text-sm font-medium text-foreground mb-2">Work Start Time</label>
            <input type="time" id="workStartTime" value="09:00" class="w-full px-4 py-3 bg-background border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
          </div>

          <div>
            <label class="block text-sm font-medium text-foreground mb-2">Late Time Cutoff</label>
            <input type="time" id="lateCutoffTime" value="09:15" class="w-full px-4 py-3 bg-background border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
            <p class="text-xs text-muted mt-2">Arrivals after this time will be marked as "Late"</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-foreground mb-2">Work End Time</label>
            <input type="time" id="workEndTime" value="17:00" class="w-full px-4 py-3 bg-background border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
          </div>

          <div>
            <label class="block text-sm font-medium text-foreground mb-2">Timezone</label>
            <select id="timezone" class="w-full px-4 py-3 bg-background border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
              <option value="UTC-5">Eastern Time (UTC-5)</option>
              <option value="UTC-6">Central Time (UTC-6)</option>
              <option value="UTC-7">Mountain Time (UTC-7)</option>
              <option value="UTC-8">Pacific Time (UTC-8)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- AI Recognition Settings -->
      <div class="bg-card border border-border rounded-xl p-6">
        <div class="flex items-center gap-3 mb-6">
          <div class="w-10 h-10 rounded-xl bg-blue-500/10 flex items-center justify-center">
            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
          </div>
          <div>
            <h3 class="font-semibold text-foreground">AI Recognition</h3>
            <p class="text-sm text-muted">Adjust matching algorithm parameters</p>
          </div>
        </div>

        <div class="space-y-5">
          <div>
            <div class="flex items-center justify-between mb-2">
              <label class="text-sm font-medium text-foreground">Matching Threshold (Distance)</label>
              <span class="text-sm text-primary font-mono" id="thresholdValue">0.50</span>
            </div>
            <input type="range" min="0.3" max="0.7" step="0.05" value="0.5" id="matchingThreshold" class="w-full h-2 bg-background rounded-lg appearance-none cursor-pointer accent-primary" oninput="updateThreshold(this.value)">
            <div class="flex justify-between text-xs text-muted mt-2">
              <span>Strict (0.30)</span>
              <span>Lenient (0.70)</span>
            </div>
            <p class="text-xs text-muted mt-3 p-3 bg-background rounded-lg">
              <strong class="text-foreground">Note:</strong> Lower values require closer face matches (stricter, recommended: 0.4-0.5). Higher values are more permissive but may cause false positives.
            </p>
          </div>

          <div>
            <label class="block text-sm font-medium text-foreground mb-2">Detection Model</label>
            <select id="detectionModel" class="w-full px-4 py-3 bg-background border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
              <option value="tiny_face_detector" selected>Tiny Face Detector (Faster)</option>
              <option value="ssd_mobilenetv1">SSD MobileNet v1 (More Accurate)</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-foreground mb-2">Input Size</label>
            <select id="inputSize" class="w-full px-4 py-3 bg-background border border-border rounded-lg text-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
              <option value="224">224px (Faster, Less Accurate)</option>
              <option value="320">320px (Balanced)</option>
              <option value="416" selected>416px (Recommended)</option>
              <option value="512">512px (Slower, More Accurate)</option>
            </select>
            <p class="text-xs text-muted mt-2">Higher values improve accuracy but reduce speed</p>
          </div>
        </div>
      </div>

      <!-- Save Actions -->
    <div class="mt-8 bg-card border border-border rounded-xl p-6">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="font-semibold text-foreground">Save Configuration</h3>
          <p class="text-sm text-muted mt-1">Changes will take effect immediately after saving</p>
        </div>
        <div class="flex gap-3">
          <button onclick="resetDefaults()" class="py-3 px-6 bg-background border border-border text-foreground font-medium rounded-lg hover:bg-card transition-all">
            Reset to Defaults
          </button>
          <button onclick="saveSettings()" class="py-3 px-6 bg-primary text-background font-semibold rounded-lg hover:bg-primary/90 transition-all flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Save Changes
          </button>
        </div>
      </div>
    </div>
  </main>

  <script>
    let currentSettings = null;

    // Load settings on page load
    async function loadSettings() {
      try {
        const response = await fetch('/api/settings');
        const settings = await response.json();
        currentSettings = settings;
        
        // Populate form fields
        document.getElementById('cameraType').value = settings.cameraType || 'webcam';
        document.getElementById('ipCameraUrl').value = settings.ipCameraUrl || '';
        
        // Show saved video file info if exists
        if (settings.videoFilePath) {
          const fileName = settings.videoFilePath.split(/[\\/]/).pop();
          document.getElementById('videoUploadArea').classList.add('hidden');
          document.getElementById('videoFileInfo').classList.remove('hidden');
          document.getElementById('videoFileName').textContent = fileName;
          uploadedVideoFile = { serverPath: settings.videoFilePath };
        }
        
        document.getElementById('workStartTime').value = settings.workStartTime || '09:00';
        document.getElementById('lateCutoffTime').value = settings.lateCutoffTime || '09:15';
        document.getElementById('workEndTime').value = settings.workEndTime || '17:00';
        document.getElementById('timezone').value = settings.timezone || 'UTC-5';
        
        document.getElementById('matchingThreshold').value = settings.matchingThreshold || 0.75;
        document.getElementById('thresholdValue').textContent = settings.matchingThreshold || 0.75;
        document.getElementById('detectionModel').value = settings.detectionModel || 'tiny_face_detector';
        document.getElementById('inputSize').value = settings.inputSize || 416;
        
        toggleIpCameraSection();
      } catch (error) {
        console.error('Error loading settings:', error);
        showNotification('Failed to load settings', 'error');
      }
    }

    function updateThreshold(value) {
      document.getElementById('thresholdValue').textContent = value;
    }

    function toggleIpCameraSection() {
      const cameraType = document.getElementById('cameraType').value;
      const ipSection = document.getElementById('ipCameraSection');
      const videoSection = document.getElementById('videoFileSection');
      const testBtn = document.getElementById('testCameraBtn');
      
      // Hide all sections first
      ipSection.style.display = 'none';
      videoSection.style.display = 'none';
      
      if (cameraType === 'ip') {
        ipSection.style.display = 'block';
        testBtn.style.display = 'flex';
      } else if (cameraType === 'video') {
        videoSection.style.display = 'block';
        testBtn.style.display = 'none';
      } else {
        testBtn.style.display = 'flex';
      }
    }

    document.getElementById('cameraType').addEventListener('change', toggleIpCameraSection);

    // Video file handling
    let uploadedVideoFile = null;
    
    document.getElementById('videoFileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      // Validate file size (500MB max)
      if (file.size > 500 * 1024 * 1024) {
        showNotification('File too large. Maximum size is 500MB', 'error');
        return;
      }
      
      // Validate file type
      const allowedTypes = ['video/mp4', 'video/avi', 'video/quicktime', 'video/x-matroska', 'video/webm'];
      if (!allowedTypes.includes(file.type) && !file.name.match(/\.(mp4|avi|mov|mkv|webm)$/i)) {
        showNotification('Invalid file type. Please upload MP4, AVI, MOV, MKV, or WebM', 'error');
        return;
      }
      
      uploadedVideoFile = file;
      
      // Show file info
      document.getElementById('videoUploadArea').classList.add('hidden');
      document.getElementById('videoFileInfo').classList.remove('hidden');
      document.getElementById('videoFileName').textContent = file.name;
      
      // Upload the file
      await uploadVideoFile(file);
    });
    
    async function clearVideoFile() {
      // Delete from server if there's an uploaded file
      if (uploadedVideoFile?.serverPath || currentSettings?.videoFilePath) {
        try {
          const response = await fetch('/api/camera/video', { method: 'DELETE' });
          const result = await response.json();
          if (result.success) {
            showNotification('Video removed successfully', 'success');
          }
        } catch (error) {
          console.error('Error deleting video:', error);
        }
      }
      
      uploadedVideoFile = null;
      if (currentSettings) {
        currentSettings.videoFilePath = '';
      }
      document.getElementById('videoFileInput').value = '';
      document.getElementById('videoUploadArea').classList.remove('hidden');
      document.getElementById('videoFileInfo').classList.add('hidden');
      document.getElementById('uploadProgress').classList.add('hidden');
    }
    
    async function uploadVideoFile(file) {
      const formData = new FormData();
      formData.append('video', file);
      
      document.getElementById('uploadProgress').classList.remove('hidden');
      
      try {
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            document.getElementById('uploadProgressBar').style.width = percent + '%';
            document.getElementById('uploadProgressText').textContent = `Uploading... ${percent}%`;
          }
        });
        
        xhr.addEventListener('load', () => {
          if (xhr.status === 200) {
            const result = JSON.parse(xhr.responseText);
            if (result.success) {
              showNotification('Video uploaded successfully!', 'success');
              document.getElementById('uploadProgressText').textContent = 'Upload complete!';
              // Store the video path for saving
              uploadedVideoFile.serverPath = result.filePath;
            } else {
              showNotification(result.message || 'Upload failed', 'error');
              clearVideoFile();
            }
          } else {
            showNotification('Upload failed', 'error');
            clearVideoFile();
          }
        });
        
        xhr.addEventListener('error', () => {
          showNotification('Upload failed', 'error');
          clearVideoFile();
        });
        
        xhr.open('POST', '/api/camera/upload-video');
        xhr.send(formData);
      } catch (error) {
        console.error('Error uploading video:', error);
        showNotification('Failed to upload video', 'error');
        clearVideoFile();
      }
    }

    async function testCamera() {
      const cameraType = document.getElementById('cameraType').value;
      const ipCameraUrl = document.getElementById('ipCameraUrl').value;
      
      if (cameraType === 'ip' && !ipCameraUrl) {
        showNotification('Please enter an IP camera URL', 'error');
        return;
      }
      
      showNotification('Testing camera connection...', 'info');
      
      try {
        const response = await fetch('/api/camera/test', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            cameraType: cameraType,
            ipCameraUrl: ipCameraUrl
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showNotification(result.message, 'success');
        } else {
          showNotification(result.message, 'error');
        }
      } catch (error) {
        console.error('Error testing camera:', error);
        showNotification('Failed to test camera connection', 'error');
      }
    }

    async function saveSettings() {
      try {
        const settings = {
          cameraType: document.getElementById('cameraType').value,
          ipCameraUrl: document.getElementById('ipCameraUrl').value,
          videoFilePath: uploadedVideoFile?.serverPath || currentSettings?.videoFilePath || '',
          
          workStartTime: document.getElementById('workStartTime').value,
          lateCutoffTime: document.getElementById('lateCutoffTime').value,
          workEndTime: document.getElementById('workEndTime').value,
          timezone: document.getElementById('timezone').value,
          
          matchingThreshold: parseFloat(document.getElementById('matchingThreshold').value),
          detectionModel: document.getElementById('detectionModel').value,
          inputSize: parseInt(document.getElementById('inputSize').value)
        };
        
        const response = await fetch('/api/settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(settings)
        });
        
        const result = await response.json();
        
        if (result.success) {
          showNotification('Settings saved successfully!', 'success');
          currentSettings = result.settings;
        } else {
          showNotification('Failed to save settings', 'error');
        }
      } catch (error) {
        console.error('Error saving settings:', error);
        showNotification('Failed to save settings', 'error');
      }
    }

    async function resetDefaults() {
      if (!confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
        return;
      }
      
      try {
        const response = await fetch('/api/settings/reset', {
          method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
          showNotification('Settings reset to defaults', 'success');
          await loadSettings();
        } else {
          showNotification('Failed to reset settings', 'error');
        }
      } catch (error) {
        console.error('Error resetting settings:', error);
        showNotification('Failed to reset settings', 'error');
      }
    }

    function showNotification(message, type = 'info') {
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
      };
      
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Load settings when page loads
    loadSettings();
  </script>
</body>
</html>
