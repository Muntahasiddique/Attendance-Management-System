# Database Schema Documentation

Complete database schema reference for the Attendance Management System (AMS-AI).

## Table of Contents

- [Overview](#overview)
- [Collections](#collections)
  - [Admin](#admin)
  - [Student](#student)
  - [Class](#class)
  - [Course](#course)
  - [Attendance](#attendance)
  - [Settings](#settings)
- [Relationships](#relationships)
- [Indexes](#indexes)
- [Data Validation](#data-validation)

---

## Overview

AMS-AI uses MongoDB as its database with Mongoose as the ODM (Object Data Modeling) library. The database consists of 6 main collections that handle users, classes, courses, attendance records, and user settings.

### Database Name
```
ams-ai
```

### Connection String
```
mongodb://localhost:27017/ams-ai
```

---

## Collections

### Admin

Stores administrator and teacher user accounts.

```javascript
const AdminSchema = new mongoose.Schema({
  fullName: {
    type: String,
    required: true,
    trim: true
  },
  email: {
    type: String,
    required: true,
    unique: true,
    lowercase: true,
    trim: true
  },
  password: {
    type: String,
    required: true
  },
  role: {
    type: String,
    enum: ['admin', 'teacher'],
    default: 'teacher'
  },
  department: {
    type: String,
    trim: true
  },
  isActive: {
    type: Boolean,
    default: true
  },
  createdAt: {
    type: Date,
    default: Date.now
  },
  updatedAt: {
    type: Date,
    default: Date.now
  }
});
```

**Example Document:**
```json
{
  "_id": "507f1f77bcf86cd799439011",
  "fullName": "Dr. John Smith",
  "email": "john.smith@university.edu",
  "password": "$2a$10$...", // bcrypt hashed
  "role": "teacher",
  "department": "Computer Science",
  "isActive": true,
  "createdAt": "2025-01-01T00:00:00.000Z",
  "updatedAt": "2025-12-10T00:00:00.000Z"
}
```

---

### Student

Stores student accounts with face recognition data.

```javascript
const StudentSchema = new mongoose.Schema({
  fullName: {
    type: String,
    required: true,
    trim: true
  },
  email: {
    type: String,
    required: true,
    unique: true,
    lowercase: true,
    trim: true
  },
  password: {
    type: String,
    required: true
  },
  rollNo: {
    type: String,
    required: true,
    trim: true
  },
  classRef: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Class',
    required: true
  },
  faceDescriptor: {
    type: [Number],
    default: []
    // 128-dimensional float array from face-api.js
  },
  faceImagePath: {
    type: String
  },
  isEnrolled: {
    type: Boolean,
    default: true
  },
  lastDescriptorUpdate: {
    type: Date
  },
  descriptorUpdateCount: {
    type: Number,
    default: 0
  },
  createdAt: {
    type: Date,
    default: Date.now
  },
  updatedAt: {
    type: Date,
    default: Date.now
  }
});
```

**Example Document:**
```json
{
  "_id": "507f1f77bcf86cd799439013",
  "fullName": "Alice Johnson",
  "email": "alice.johnson@student.edu",
  "password": "$2a$10$...",
  "rollNo": "CS2021001",
  "classRef": "507f1f77bcf86cd799439011",
  "faceDescriptor": [0.123, -0.456, 0.789, ...], // 128 values
  "faceImagePath": "uploads/faces/alice_johnson.jpg",
  "isEnrolled": true,
  "lastDescriptorUpdate": "2025-12-10T09:30:00.000Z",
  "descriptorUpdateCount": 15,
  "createdAt": "2025-08-01T00:00:00.000Z",
  "updatedAt": "2025-12-10T09:30:00.000Z"
}
```

**Face Descriptor Notes:**
- 128-dimensional Float32 array
- Generated by face-api.js FaceRecognitionNet
- Updated using Exponential Moving Average (EMA)
- Formula: `new = old × 0.85 + current × 0.15`
- Only updated when confidence ≥ 0.6

---

### Class

Stores class/section information.

```javascript
const ClassSchema = new mongoose.Schema({
  name: {
    type: String,
    required: true,
    trim: true
  },
  semester: {
    type: String,
    required: true
  },
  section: {
    type: String,
    required: true,
    trim: true
  },
  department: {
    type: String,
    trim: true
  },
  academicYear: {
    type: String
  },
  createdAt: {
    type: Date,
    default: Date.now
  }
});
```

**Example Document:**
```json
{
  "_id": "507f1f77bcf86cd799439011",
  "name": "Computer Science",
  "semester": "5",
  "section": "A",
  "department": "CS",
  "academicYear": "2025-2026",
  "createdAt": "2025-01-01T00:00:00.000Z"
}
```

---

### Course

Stores course information with instructor assignment.

```javascript
const CourseSchema = new mongoose.Schema({
  name: {
    type: String,
    required: true,
    trim: true
  },
  code: {
    type: String,
    required: true,
    trim: true,
    uppercase: true
  },
  classRef: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Class',
    required: true
  },
  instructorRef: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Admin',
    required: true
  },
  credits: {
    type: Number,
    default: 3
  },
  description: {
    type: String
  },
  isActive: {
    type: Boolean,
    default: true
  },
  createdAt: {
    type: Date,
    default: Date.now
  }
});
```

**Example Document:**
```json
{
  "_id": "507f1f77bcf86cd799439012",
  "name": "Database Management Systems",
  "code": "CS301",
  "classRef": "507f1f77bcf86cd799439011",
  "instructorRef": "507f1f77bcf86cd799439018",
  "credits": 4,
  "description": "Introduction to database concepts",
  "isActive": true,
  "createdAt": "2025-01-15T00:00:00.000Z"
}
```

---

### Attendance

Stores attendance records for each student session.

```javascript
const AttendanceSchema = new mongoose.Schema({
  studentRef: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Student',
    required: true
  },
  courseRef: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Course',
    required: true
  },
  classRef: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Class',
    required: true
  },
  status: {
    type: String,
    enum: ['present', 'late', 'absent'],
    required: true
  },
  confidenceScore: {
    type: Number,
    min: 0,
    max: 1,
    default: 0
  },
  markedBy: {
    type: String,
    enum: ['facial_recognition', 'manual', 'session_end'],
    default: 'facial_recognition'
  },
  sessionDate: {
    type: Date,
    required: true
  },
  timestamp: {
    type: Date,
    default: Date.now
  }
});
```

**Example Document:**
```json
{
  "_id": "507f1f77bcf86cd799439014",
  "studentRef": "507f1f77bcf86cd799439013",
  "courseRef": "507f1f77bcf86cd799439012",
  "classRef": "507f1f77bcf86cd799439011",
  "status": "present",
  "confidenceScore": 0.85,
  "markedBy": "facial_recognition",
  "sessionDate": "2025-12-10T00:00:00.000Z",
  "timestamp": "2025-12-10T09:30:15.000Z"
}
```

**Status Values:**
| Status | Description |
|--------|-------------|
| `present` | Arrived before late cutoff time |
| `late` | Arrived after late cutoff time |
| `absent` | Did not attend or marked absent |

**MarkedBy Values:**
| Value | Description |
|-------|-------------|
| `facial_recognition` | Automatically detected by AI |
| `manual` | Manually marked by teacher |
| `session_end` | Auto-marked absent when session ended |

---

### Settings

Stores per-user camera and recognition settings.

```javascript
const SettingsSchema = new mongoose.Schema({
  userId: {
    type: mongoose.Schema.Types.ObjectId,
    required: true,
    refPath: 'userModel'
  },
  userModel: {
    type: String,
    enum: ['Admin', 'Teacher'],
    required: true
  },
  cameraType: {
    type: String,
    enum: ['webcam', 'usb', 'ip', 'video'],
    default: 'webcam'
  },
  ipCameraUrl: {
    type: String,
    default: ''
  },
  videoFilePath: {
    type: String,
    default: ''
  },
  matchingThreshold: {
    type: Number,
    min: 0.5,
    max: 0.95,
    default: 0.6
  },
  inputSize: {
    type: Number,
    enum: [224, 320, 416, 512],
    default: 416
  },
  detectionModel: {
    type: String,
    enum: ['tiny', 'ssd'],
    default: 'tiny'
  },
  workStartTime: {
    type: String,
    default: '09:00'
  },
  lateCutoffTime: {
    type: String,
    default: '09:30'
  },
  workEndTime: {
    type: String,
    default: '17:00'
  },
  timezone: {
    type: String,
    default: 'Asia/Kolkata'
  },
  createdAt: {
    type: Date,
    default: Date.now
  },
  updatedAt: {
    type: Date,
    default: Date.now
  }
});
```

**Example Document:**
```json
{
  "_id": "507f1f77bcf86cd799439017",
  "userId": "507f1f77bcf86cd799439018",
  "userModel": "Admin",
  "cameraType": "ip",
  "ipCameraUrl": "rtsp://192.168.0.103:554/stream",
  "videoFilePath": "",
  "matchingThreshold": 0.75,
  "inputSize": 416,
  "detectionModel": "tiny",
  "workStartTime": "09:00",
  "lateCutoffTime": "09:30",
  "workEndTime": "17:00",
  "timezone": "Asia/Kolkata",
  "createdAt": "2025-01-01T00:00:00.000Z",
  "updatedAt": "2025-12-10T00:00:00.000Z"
}
```

---

## Relationships

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    Admin    │     │    Class    │     │   Student   │
│  (Teacher)  │     │             │     │             │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │
       │ instructorRef     │ classRef          │ classRef
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────────────────────────────────────────────┐
│                        Course                        │
│  - Links Teacher to Class                           │
│  - One Teacher can have multiple Courses            │
│  - One Class can have multiple Courses              │
└─────────────────────────────────────────────────────┘
                           │
                           │ courseRef
                           ▼
┌─────────────────────────────────────────────────────┐
│                      Attendance                      │
│  - Links Student, Course, and Class                 │
│  - One record per student per course per day        │
│  - Stores timestamp and confidence score            │
└─────────────────────────────────────────────────────┘

┌─────────────┐
│   Settings  │──── userId ────▶ Admin (Teacher)
└─────────────┘
```

### Relationship Summary

| From | To | Relationship | Field |
|------|-----|--------------|-------|
| Student | Class | Many-to-One | `classRef` |
| Course | Class | Many-to-One | `classRef` |
| Course | Admin | Many-to-One | `instructorRef` |
| Attendance | Student | Many-to-One | `studentRef` |
| Attendance | Course | Many-to-One | `courseRef` |
| Attendance | Class | Many-to-One | `classRef` |
| Settings | Admin | One-to-One | `userId` |

---

## Indexes

### Recommended Indexes

```javascript
// Admin indexes
AdminSchema.index({ email: 1 }, { unique: true });
AdminSchema.index({ role: 1 });

// Student indexes
StudentSchema.index({ email: 1 }, { unique: true });
StudentSchema.index({ classRef: 1 });
StudentSchema.index({ rollNo: 1, classRef: 1 });
StudentSchema.index({ isEnrolled: 1 });

// Course indexes
CourseSchema.index({ classRef: 1 });
CourseSchema.index({ instructorRef: 1 });
CourseSchema.index({ code: 1 }, { unique: true });

// Attendance indexes (IMPORTANT for performance)
AttendanceSchema.index({ studentRef: 1, courseRef: 1, sessionDate: 1 }, { unique: true });
AttendanceSchema.index({ courseRef: 1, sessionDate: 1 });
AttendanceSchema.index({ classRef: 1, sessionDate: 1 });
AttendanceSchema.index({ timestamp: -1 });
AttendanceSchema.index({ status: 1 });

// Settings indexes
SettingsSchema.index({ userId: 1, userModel: 1 }, { unique: true });
```

---

## Data Validation

### Email Validation
```javascript
email: {
  type: String,
  required: true,
  unique: true,
  lowercase: true,
  trim: true,
  match: [/^\S+@\S+\.\S+$/, 'Please use a valid email address']
}
```

### Password Requirements
- Minimum 6 characters
- Hashed using bcryptjs with 10 salt rounds

### Face Descriptor Validation
```javascript
faceDescriptor: {
  type: [Number],
  validate: {
    validator: function(arr) {
      return arr.length === 0 || arr.length === 128;
    },
    message: 'Face descriptor must be empty or have exactly 128 values'
  }
}
```

### Time Format Validation
```javascript
lateCutoffTime: {
  type: String,
  match: [/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/, 'Time must be in HH:MM format']
}
```

---

## Migration Notes

### Adding New Fields

When adding new fields to existing schemas, use MongoDB's `$set` with default values:

```javascript
// Example: Adding descriptorUpdateCount to existing students
db.students.updateMany(
  { descriptorUpdateCount: { $exists: false } },
  { $set: { descriptorUpdateCount: 0 } }
);
```

### Backup Commands

```bash
# Backup entire database
mongodump --db ams-ai --out ./backup

# Restore database
mongorestore --db ams-ai ./backup/ams-ai
```
